<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏ß‡∏¢ Simulator Demo</title>

<style>
    body {
        background:#f7d3f2;
        font-family:'Sarabun', sans-serif;
        padding:20px;
    }
    .box {
        width:100%;
        max-width:500px;
        margin:auto;
        background:#fff;
        padding:20px;
        border-radius:15px;
        box-shadow:0 5px 20px rgba(0,0,0,0.15);
    }
    h2 {
        text-align:center;
        color:#c449d5;
        margin-bottom:20px;
    }

    .mode-row {
        display:flex;
        gap:10px;
        margin-bottom:15px;
    }
    .mode-btn {
        background:#ffe9a8;
        border:none;
        padding:10px 18px;
        border-radius:8px;
        cursor:pointer;
        font-weight:bold;
    }
    .mode-btn.active {
        background:#ffb700;
        color:white;
    }

    input[type="text"] {
        width:100%;
        padding:12px;
        border-radius:10px;
        border:1px solid #aaa;
        font-size:16px;
    }

    .numbers-container {
        min-height:50px;
        padding:10px;
        border-radius:10px;
        border:1px solid:#ddd;
        background:#fffafc;
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        margin-top:4px;
    }
    .num-pill {
        background:#1e6bff;
        color:#fff;
        padding:6px 10px;
        border-radius:8px;
        font-size:15px;
        font-weight:bold;
        cursor:pointer;
    }
    .num-pill.error { background:#ff3b3b; }

    .row { display:flex; gap:10px; margin:10px 0; }

    input[type="number"] {
        width:100%;
        padding:12px;
        border-radius:10px;
        border:1px solid:#ccc;
        font-size:16px;
    }

    button {
        padding:12px 16px;
        font-size:16px;
        border-radius:10px;
        border:none;
        cursor:pointer;
        font-weight:bold;
    }
    .btn-rev  { background:#ffe06c; }
    .btn-clear{ background:#ffb3c1; }
    .btn-add  { background:#ff44c7; color:white; }

    .bill-box {
        margin-top:20px;
        background:#ffe7f8;
        padding:15px;
        border-radius:15px;
    }

    .bill {
        background:white;
        padding:15px;
        border-radius:12px;
        margin-bottom:15px;
        display:flex;
        justify-content:space-between;
        border:1px solid #ddd;
    }

    .bill-left { width:85%; }

    .bill-title { font-weight:bold; font-size:17px; margin-bottom:5px; }

    .bill-price { color:#777; font-size:14px; }

    .bill-nums {
        background:#f8f8f8;
        padding:10px;
        border-radius:10px;
        border:1px solid #ddd;
        font-size:15px;
        margin-bottom:8px;
        white-space:normal;
        word-break:break-word;
    }

    .bill-line { white-space:nowrap; margin-bottom:4px; }

    .del-btn { font-size:22px; color:red; cursor:pointer; }

    .total-all {
        text-align:center;
        font-size:22px;
        margin-top:20px;
        font-weight:bold;
    }
</style>
</head>

<body>

<div class="box">

    <h2>‡∏´‡∏ß‡∏¢ Simulator Demo</h2>

    <div class="mode-row">
        <button class="mode-btn active" id="btn2d" onclick="switchMode('2d')">2 ‡∏ï‡∏±‡∏ß</button>
        <button class="mode-btn" id="btn3d" onclick="switchMode('3d')">3 ‡∏ï‡∏±‡∏ß</button>
        <button class="mode-btn" id="btn19" onclick="switchMode('19')">19 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π</button>
        <button class="mode-btn" id="btnRun" onclick="switchMode('run')">‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á</button>
    </div>

    <div class="label">‡∏ä‡πà‡∏≠‡∏á 1: ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç</div>
    <input id="inputNums" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 23 / 231 / 1 (19 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π)">

    <div class="label">‡∏ä‡πà‡∏≠‡∏á 2: ‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô</div>
    <div id="numbersContainer" class="numbers-container"></div>

    <div class="row">
        <button class="btn-rev" onclick="reverseNumbers()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏Ç</button>
        <button class="btn-clear" onclick="clearNumbersAndBills()">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç</button>
    </div>

    <div class="row">
        <input id="top" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ö‡∏ô">
        <input id="bottom" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏•‡πà‡∏≤‡∏á">
    </div>

    <button class="btn-add" onclick="addBillAndReset()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•</button>

    <div class="bill-box" id="billList"></div>
    <div id="totalAll" class="total-all">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ö‡∏≤‡∏ó</div>

</div>

<script>
let bills = [];
let currentNums = [];
let mode = "2d";
let isPaste = false;

const DELAY = 60; // <<==== ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå 60ms ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Chang ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

const inputNums = document.getElementById("inputNums");
const numbersContainer = document.getElementById("numbersContainer");
const topPrice = document.getElementById("top");
const bottomPrice = document.getElementById("bottom");

const pad2 = n => n.toString().padStart(2,"0");
const pad3 = n => n.toString().padStart(3,"0");

/* ---------------- Switch Mode ---------------- */
function switchMode(m){
    mode = m;

    document.querySelectorAll(".mode-btn").forEach(x=>x.classList.remove("active"));
    document.getElementById("btn2d").classList.toggle("active", m==="2d");
    document.getElementById("btn3d").classList.toggle("active", m==="3d");
    document.getElementById("btn19").classList.toggle("active", m==="19");
    document.getElementById("btnRun").classList.toggle("active", m==="run");

    clearNumbers();
    inputNums.value = "";
    inputNums.focus();
}

/* ---------------- Render Pills ---------------- */
function renderNumbers(){
    numbersContainer.innerHTML = "";
    currentNums.forEach((obj,idx)=>{
        let b=document.createElement("button");
        b.className = obj.error ? "num-pill error" : "num-pill";
        b.textContent = obj.val;
        b.onclick = ()=>{
            currentNums.splice(idx,1);
            renderNumbers();
        };
        numbersContainer.appendChild(b);
    });
}

/* ---------------- Prevent paste for 19/run ---------------- */
inputNums.addEventListener("paste", e=>{
    if(mode==="19" || mode==="run"){
        e.preventDefault();
        return;
    }
    isPaste = true;
});

/* ===========================================================
   INPUT HANDLER (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ)
   =========================================================== */
inputNums.addEventListener("input", e=>{
    let v = e.target.value;

    /* ---------- 19 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π ---------- */
    if(mode==="19"){
        let d = v.replace(/\D/g,"");

        currentNums = [];
        if(d.length>=1){
            let x = d[0];
            let arr = [];
            for(let i=0;i<10;i++) arr.push(x+i);
            for(let i=0;i<10;i++) arr.push(i+x);
            arr = [...new Set(arr)];
            currentNums = arr.map(n=>({val:n,error:false}));
        }
        renderNumbers();

        setTimeout(()=> inputNums.value="", DELAY);
        return;
    }

    /* ---------- ‡∏ß‡∏¥‡πà‡∏á ---------- */
    if(mode==="run"){
        let d = v.replace(/\D/g,"");

        currentNums = [];
        if(d.length>=1){
            currentNums = [{val:d[0],error:false}];
        }
        renderNumbers();

        setTimeout(()=> inputNums.value="", DELAY);
        return;
    }

    /* ---------- 2 ‡∏ï‡∏±‡∏ß / 3 ‡∏ï‡∏±‡∏ß : PASTE MODE ---------- */
    if(isPaste){
        let clean = v.replace(/[^0-9\s]/g," ");
        let tokens = clean.split(/\s+/).filter(x=>x);

        tokens.forEach(t=>{
            if(mode==="2d"){
                if(t.length===2) currentNums.push({val:pad2(t),error:false});
                else currentNums.push({val:t,error:true});
            }
            if(mode==="3d"){
                if(t.length===3) currentNums.push({val:pad3(t),error:false});
                else currentNums.push({val:t,error:true});
            }
        });

        isPaste = false;

        renderNumbers();
        setTimeout(()=> inputNums.value="", DELAY);
        return;
    }

    /* ---------- 2 ‡∏ï‡∏±‡∏ß ---------- */
    if(mode==="2d"){
        let d = v.replace(/\D/g,"");

        if(d.length < 2) return;

        let two = d.slice(0,2);
        currentNums.push({val:pad2(two), error:false});
        renderNumbers();

        setTimeout(()=> inputNums.value="", DELAY);
        return;
    }

    /* ---------- 3 ‡∏ï‡∏±‡∏ß ---------- */
    if(mode==="3d"){
        let d = v.replace(/\D/g,"");

        if(d.length < 3) return;

        let three = d.slice(0,3);
        currentNums.push({val:pad3(three), error:false});
        renderNumbers();

        setTimeout(()=> inputNums.value="", DELAY);
        return;
    }
});

/* ---------------- Reverse ---------------- */
function reverseNumbers(){
    if(mode==="19" || mode==="run") return;

    let add = [];

    currentNums.forEach(obj=>{
        if(obj.error) return;

        if(mode==="2d"){
            let a=obj.val[0], b=obj.val[1];
            if(a!==b){
                let r=pad2(b+a);
                if(!currentNums.some(o=>o.val===r))
                    add.push({val:r,error:false});
            }
        }

        if(mode==="3d"){
            let [a,b,c]=obj.val.split("");
            let set=new Set([a+b+c,a+c+b,b+a+c,b+c+a,c+a+b,c+b+a]);
            set.forEach(x=>{
                if(!currentNums.some(o=>o.val===x))
                    add.push({val:x,error:false});
            });
        }
    });

    currentNums=currentNums.concat(add);
    renderNumbers();
}

/* ---------------- Clear Numbers + Bills ---------------- */
function clearNumbers(){
    currentNums=[];
    renderNumbers();
}

function clearNumbersAndBills(){
    clearNumbers();
    bills=[];
    renderBills();
}

/* ---------------- Add Bill ---------------- */
function addBill(){
    let valid = currentNums.filter(o=>!o.error).map(o=>o.val);
    if(valid.length===0) return false;

    let t = Number(topPrice.value||0);
    let b = Number(bottomPrice.value||0);

    bills.push({
        nums:valid,
        top:t,
        bottom:b,
        total: valid.length*(t+b),
        mode:mode
    });

    renderBills();
    return true;
}

function addBillAndReset(){
    if(!addBill()) return;
    clearNumbers();
    inputNums.value="";
    topPrice.value="";
    bottomPrice.value="";
    inputNums.focus();
}

/* ---------------- Delete Bill ---------------- */
function delBill(i){
    bills.splice(i,1);
    renderBills();
}

/* ---------------- Render Bills ---------------- */
function renderBills(){
    let html="";
    let total=0;

    const box=document.getElementById("billList");
    const maxW=Math.max((box.clientWidth||0)-40,100);

    bills.forEach((b,i)=>{
        total+=b.total;

        let widthForThis = (b.mode==="3d") ? maxW : maxW*0.7;

        let lines=[];
        let line="";
        let w=0;

        // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        ctx.font="15px Sarabun";

        b.nums.forEach(n=>{
            const token=(line?" ":"")+n;
            const ww=ctx.measureText(token).width;
            if(line && w+ww > widthForThis){
                lines.push(line);
                line=n;
                w=ctx.measureText(n).width;
            }else{
                line+=(line?" ":"")+n;
                w+=ww;
            }
        });
        if(line) lines.push(line);

        let printLines = lines.map(l=>`<div class="bill-line">${l}</div>`).join("");

        html+=`
        <div class="bill">
            <div class="bill-left">
                <div class="bill-title">${
                    b.mode==="2d"?"2 ‡∏ï‡∏±‡∏ß":
                    b.mode==="3d"?"3 ‡∏ï‡∏±‡∏ß":
                    b.mode==="19"?"19 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π":
                    "‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á"
                }</div>

                <div class="bill-price">${b.top} √ó ${b.bottom}</div>

                <div class="bill-nums">${printLines}</div>
            </div>
            <div class="del-btn" onclick="delBill(${i})">üóë</div>
        </div>`;
    });

    document.getElementById("billList").innerHTML=html;
    document.getElementById("totalAll").innerText=
        `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ö‡∏≤‡∏ó`;
}

/* ---------------- TAB ---------------- */
document.addEventListener("keydown", e=>{
    if(e.key!=="Tab") return;
    e.preventDefault();

    if(document.activeElement===inputNums){
        topPrice.focus(); topPrice.select(); return;
    }
    if(document.activeElement===topPrice){
        bottomPrice.focus(); bottomPrice.select(); return;
    }
    if(document.activeElement===bottomPrice){
        addBillAndReset(); return;
    }

    inputNums.focus();
});

/* ---------------- SPACE = REVERSE ---------------- */
document.addEventListener("keydown", e=>{
    if(e.code==="Space"){
        if(mode==="19" || mode==="run") return;
        e.preventDefault();
        reverseNumbers();
    }
});
</script>

</body>
</html>
